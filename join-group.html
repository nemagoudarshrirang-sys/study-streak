<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Join Group</title>

<style>
body{
  background:#020617;
  color:#e5e7eb;
  font-family:Segoe UI;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:320px;
  background:#0f172a;
  padding:24px;
  border-radius:18px;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
  border:none;
}
input{background:#020617;color:#fff;text-align:center;letter-spacing:3px}
button{background:#22c55e;font-weight:600}
.small{font-size:13px;color:#94a3b8;margin-top:6px}
.error{color:#f87171}
</style>
</head>

<body>
<div class="card">
  <h2>ðŸ”‘ Join Group</h2>
  <input id="code" placeholder="ABC123">
  <button onclick="join()">Join</button>
  <div class="small" id="status"></div>
</div>

<script src="env.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
try{ if(!firebase.apps.length){ firebase.initializeApp(window.__FIREBASE_CONFIG); } }catch(e){}
const db = firebase.firestore();

function getUserName(){
  let n = localStorage.getItem("userName");
  if(!n){
    n = prompt("Enter your name") || "Anonymous";
    localStorage.setItem("userName", n);
  }
  return n;
}

function join(){
  const code = document.getElementById("code").value.trim().toUpperCase();
  const status = document.getElementById("status");
  if(!code) return;

  status.className = "small";
  let dots = 0;
  const anim = setInterval(()=>{
    dots = (dots+1)%4;
    status.textContent = "Joining" + ".".repeat(dots);
  },400);

  const user = getUserName();
  const ref = db.collection("groups").doc(code);

  ref.get().then(doc=>{
    if(!doc.exists){
      clearInterval(anim);
      status.textContent = "Invalid group code";
      status.className = "small error";
      return;
    }

    const data = doc.data();
    const members = data.members || [];
    if (members.some(m => m.name === user)){
      clearInterval(anim);
      localStorage.setItem("groupCode", code);
      location.href = "groups.html";
      return;
    }

    ref.update({
      members: firebase.firestore.FieldValue.arrayUnion({ name: user, sessions: 0 })
    }).then(()=>{
      clearInterval(anim);
      localStorage.setItem("groupCode", code);
      location.href = "groups.html";
    }).catch(()=>{
      clearInterval(anim);
      status.textContent = "Failed to join";
      status.className = "small error";
    });
  }).catch(()=>{
    clearInterval(anim);
    status.textContent = "Failed to validate code";
    status.className = "small error";
  });
}
</script>
</body>
</html>
