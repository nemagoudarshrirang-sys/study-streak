<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Group Inbox</title>

<style>
body{margin:0;background:radial-gradient(circle at top, #0f172a, #020617);color:#e5e7eb;font-family:Segoe UI,system-ui;line-height:1.6}
.inbox{position:fixed;inset:0;display:flex;flex-direction:column}
.top{height:60px;display:flex;align-items:center;padding:0 16px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(17,17,17,0.95);backdrop-filter:blur(12px)}
.search{flex:1;background:rgba(26,26,26,0.8);border:none;border-radius:24px;height:40px;color:#e5e7eb;padding:0 16px;font-size:14px;backdrop-filter:blur(8px);transition:background 0.2s ease}
.search:focus{outline:none;background:rgba(30,30,30,0.9)}
.avatars{display:flex;gap:14px;padding:14px 16px;background:rgba(11,11,11,0.6);border-bottom:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(8px)}
.av{width:52px;height:52px;border-radius:50%;background:rgba(26,26,26,0.8);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;font-weight:600;backdrop-filter:blur(8px);transition:transform 0.15s ease}
.av:hover{transform:scale(1.05)}
.dot{position:absolute;bottom:2px;right:2px;width:12px;height:12px;border-radius:50%;background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,0.4)}
.list{flex:1;overflow-y:auto;padding:8px 12px;background:rgba(11,11,11,0.4)}
.list{padding-bottom:76px}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:rgba(17,17,17,0.95);border-top:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-around;z-index:50;backdrop-filter:blur(12px)}
.bn-btn{background:transparent;border:none;color:#e5e7eb;font-size:20px;cursor:pointer;opacity:0.85;transition:opacity 0.2s ease, transform 0.15s ease;padding:8px}
.bn-btn:hover{opacity:1;transform:scale(1.1)}
.bn-btn.active{color:#22c55e;opacity:1}
.row{display:flex;align-items:center;gap:12px;padding:14px;border-radius:18px;background:rgba(18,18,18,0.8);margin:8px 0;cursor:pointer;transition:all 0.2s ease;backdrop-filter:blur(8px)}
.row:hover{background:rgba(26,26,26,0.95);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.row .avatar{width:48px;height:48px;border-radius:50%;background:rgba(26,26,26,0.8);display:flex;align-items:center;justify-content:center;font-weight:700;backdrop-filter:blur(8px)}
.row .meta{flex:1;display:flex;flex-direction:column;gap:4px}
.row .line1{display:flex;justify-content:space-between;align-items:center}
.row .name{font-weight:700;font-size:15px}
.row .time{font-size:12px;color:#94a3b8;margin-left:8px}
.row .preview{font-size:13px;color:#cbd5e1;opacity:0.85;margin-top:2px;line-height:1.4}
.row .unread{width:10px;height:10px;border-radius:50%;background:#22c55e;margin-left:8px;box-shadow:0 0 6px rgba(34,197,94,0.4)}
.empty{font-size:13px;color:#94a3b8;text-align:center;margin-top:16px;line-height:1.5}
</style>
</head>

<body>
<div class="inbox">
  <div class="top">
    <input id="search" class="search" placeholder="Search or ask‚Ä¶" />
  </div>
  <div class="avatars" id="avatars"></div>
  <div class="list" id="list"></div>
  <div id="empty" class="empty" style="display:none">No groups yet.</div>
  <div id="status" class="empty" style="padding:8px"></div>
  <div class="bottom-nav">
    <button class="bn-btn" onclick="location.href='index.html'">üè†</button>
    <button class="bn-btn active" onclick="location.href='group-inbox.html'">üí¨</button>
    <button class="bn-btn" onclick="location.href='profile.html'">üôÇ</button>
    <button class="bn-btn" onclick="location.href='settings.html'">‚öôÔ∏è</button>
  </div>
</div>

<script src="env.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
try{ if(!firebase.apps.length){ firebase.initializeApp(window.__FIREBASE_CONFIG); } }catch(e){}
const db = firebase.firestore();

function getUserName(){
  let n = localStorage.getItem("userName");
  if(!n){
    n = prompt("Enter your name") || "Anonymous";
    localStorage.setItem("userName", n);
  }
  return n;
}

function minutesSince(ts){
  try{
    if(ts && ts.toMillis){
      return Math.max(0, Math.floor((Date.now()-ts.toMillis())/60000));
    }
  }catch(e){}
  return 0;
}

function renderAvatars(groups){
  const avs = document.getElementById("avatars");
  avs.innerHTML = "";
  groups.slice(0,8).forEach(g=>{
    const a = document.createElement("div");
    a.className = "av";
    a.textContent = (g.name||g.id)[0]?.toUpperCase()||"?";
    if(g.activeCount>0){
      const d = document.createElement("div"); d.className="dot"; a.appendChild(d);
    }
    a.title = g.name||g.id;
    a.onclick = ()=>{ localStorage.setItem("groupCode", g.id); location.href="groups.html"; };
    avs.appendChild(a);
  });
}

function render(groups){
  const list = document.getElementById("list");
  const empty = document.getElementById("empty");
  list.innerHTML = "";
  if(groups.length===0){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";
  groups.forEach(g=>{
    const row = document.createElement("div");
    row.className = "row";
    const av = document.createElement("div");
    av.className = "avatar";
    av.textContent = (g.name||g.id)[0]?.toUpperCase()||"?";
    const meta = document.createElement("div");
    meta.className = "meta";
    const line1 = document.createElement("div");
    line1.className = "line1";
    const name = document.createElement("span");
    name.className = "name";
    name.textContent = g.name||g.id;
    const time = document.createElement("span");
    time.className = "time";
    time.textContent = g.lastTime||"";
    const preview = document.createElement("div");
    preview.className = "preview";
    preview.textContent = g.lastPreview || (g.activeCount>0 ? `${g.activeCount} quietly focusing` : `No one studying`);
    line1.appendChild(name);
    const rightWrap = document.createElement("div");
    rightWrap.style.display="flex"; rightWrap.style.alignItems="center";
    rightWrap.appendChild(time);
    if(g.unread){ const dot=document.createElement("div"); dot.className="unread"; rightWrap.appendChild(dot); }
    line1.appendChild(rightWrap);
    meta.appendChild(line1);
    meta.appendChild(preview);
    row.appendChild(av);
    row.appendChild(meta);
    row.onclick = ()=>{ localStorage.setItem("groupCode", g.id); location.href="groups.html"; };
    list.appendChild(row);
  });
}

const status = document.getElementById("status");
status.textContent = "Loading‚Ä¶";
const user = getUserName();

db.collection("groups").onSnapshot(snap=>{
  const items = [];
  snap.forEach(doc=>{
    const data = doc.data();
    const members = data.members || [];
    if(members.some(m=>m.name===user)){
      const active = data.activeSessions||{};
      const count = Object.keys(active).length;
      let latest = null;
      try{
        Object.values(active).forEach(info=>{
          if(info && info.startedAt){
            if(!latest) latest = info.startedAt;
            else if(info.startedAt.toMillis && latest.toMillis && info.startedAt.toMillis()>latest.toMillis()) latest = info.startedAt;
          }
        });
      }catch(e){}
      items.push({ id: doc.id, name: data.name || doc.id, activeCount: count, latest });
    }
  });
  items.sort((a,b)=>{
    if(b.activeCount!==a.activeCount) return b.activeCount-a.activeCount;
    const la = a.latest && a.latest.toMillis ? a.latest.toMillis() : 0;
    const lb = b.latest && b.latest.toMillis ? b.latest.toMillis() : 0;
    return lb - la;
  });
  // Fetch last message previews
  const promises = items.map(it=>{
    return db.collection("groups").doc(it.id).collection("chat").orderBy("createdAt","desc").limit(1).get().then(s=>{
      let last = null;
      s.forEach(d=>{ last = d; });
      if(last){
        const m = last.data()||{};
        const ts = m.createdAt && m.createdAt.toMillis ? m.createdAt.toMillis() : 0;
        const minutes = ts ? Math.max(0, Math.floor((Date.now()-ts)/60000)) : 0;
        it.lastTime = minutes<60 ? `${minutes}m` : `${Math.floor(minutes/60)}h`;
        it.lastPreview = m.type==="image" ? "üì∑ Photo" :
                         m.type==="video" ? "üé¨ Video" :
                         m.type==="audio" ? "üé§ Voice message" :
                         (m.text||"").slice(0,40);
        const rb = Array.isArray(m.readBy)?m.readBy:[];
        it.unread = !rb.includes(user) && (m.author!==user);
      }else{
        it.lastTime = "";
      }
    }).catch(()=>{ it.lastTime=""; });
  });
  Promise.all(promises).then(()=>{
    renderAvatars(items);
    render(items);
  });
  status.textContent = "";
}, err=>{
  status.textContent = "Failed to load groups";
});

const searchInput = document.getElementById("search");
searchInput.addEventListener("input", ()=>{
  const q = (searchInput.value||"").toLowerCase();
  const rows = document.querySelectorAll(".list .row");
  rows.forEach(r=>{
    const name = (r.querySelector(".name")?.textContent||"").toLowerCase();
    r.style.display = name.includes(q) ? "flex" : "none";
  });
});
</script>

</body>
</html>
